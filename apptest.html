<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>QU·∫¢N L√ù TH√îNG TIN & ƒêI·ªÇM CHO SV (FOXSTUDIO)</title>
    <link rel="icon" type="image/png" href="https://uploads.onecompiler.io/43u4wb3ft/43unfu266/Black%20and%20White%20Circle%20Class%20Logo.png">
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

        // TH√îNG TIN C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N
        const firebaseConfig = {
            apiKey: "AIzaSy...", 
            authDomain: "quan-ly-sinh-vien.firebaseapp.com",
            projectId: "quan-ly-sinh-vien",
            storageBucket: "quan-ly-sinh-vien.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.firebase = { collection, getDocs, addDoc, deleteDoc, doc, updateDoc };
    </script>

    <style>
        :root {
            --bg-color: #0f172a; --text-color: #e2e8f0; --card-bg: #1e293b; --border-color: #334155; --input-bg: #334155; --input-border: #475569; --accent-color: #0ea5e9; --sidebar-bg: #1e293b; --main-font-color: var(--text-color);
        }
        body.light-mode {
            --bg-color: #f1f5f9; --text-color: #0f172a; --card-bg: rgba(255, 255, 255, 0.6); --sidebar-bg: rgba(255, 255, 255, 0.5); --border-color: rgba(203, 213, 225, 0.5); --input-bg: #e2e8f0; --input-border: #cbd5e1; --accent-color: #2563eb; --main-font-color: var(--text-color);
        }
        body.light-mode .sidebar, body.light-mode .modal-content, body.light-mode .student-card, body.light-mode .bg-card-bg { -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1); }
        .btn-primary { display: flex; align-items: center; justify-content: center; background-image: linear-gradient(to right, var(--accent-color), color-mix(in srgb, var(--accent-color) 70%, #06b6d4)); color: white; font-weight: 600; padding: 0.75rem 1rem; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all .3s; }
        .input-style { width: 100%; padding: 0.625rem 1rem; background-color: var(--input-bg); border: 1px solid var(--input-border); border-radius: 0.5rem; color: var(--main-font-color); outline: none; transition: border-color .15s, box-shadow .15s; }
        .input-style:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 40%, transparent); }
        .sidebar-link.active { background-color: var(--accent-color); color: white; font-weight: bold; }
        .td-style { padding: 0.875rem 1rem; color: var(--main-font-color); }
        .course-table-wrap { overflow-x: auto; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.show { display: flex; }
        .chatbot-container { position: fixed; bottom: 6rem; right: 1rem; z-index: 100; width: 100%; max-width: 380px; height: 500px; display: none; flex-direction: column; background-color: var(--card-bg); border-radius: 0.75rem; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); transform-origin: bottom right; transform: scale(0.9); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; }
        .chatbot-container.active { display: flex; transform: scale(1); opacity: 1; }
        .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
        .message { max-width: 85%; padding: 0.6rem 0.9rem; border-radius: 1rem; word-wrap: break-word; line-height: 1.4; }
        .user-message { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .bot-message { background-color: var(--secondary-color); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        @media print {
            body { background-color: white !important; color: black !important; padding: 0 !important; margin: 0 !important; }
            header, main, .sidebar, .fixed-buttons, footer, .modal { display: none !important; }
            #printContent { display: block !important; width: 100% !important; }
            .print-page { page-break-after: always; box-shadow: none !important; border: none !important; background-color: white !important; color: black !important; padding: 20px !important; }
            .print-page:last-child { page-break-after: avoid; }
            .print-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #333 !important; }
            .print-info { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            .print-info p { line-height: 1.5; font-size: 14px; color: #555 !important; }
            .course-table-wrap table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .course-table-wrap th, .course-table-wrap td { color: black !important; border: 1px solid #ddd !important; padding: 8px !important; text-align: center !important; font-size: 12px; }
            .course-table-wrap th { background-color: #f2f2f2 !important; font-weight: bold; }
            .gpa-info { display: block !important; margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f8f8f8; font-size: 18px; }
        }
    </style>
</head>
<body class="flex">

    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full w-64 bg-card-bg shadow-lg transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50">
        <div class="p-4 flex items-center justify-between border-b border-main"><h2 class="text-2xl font-bold text-accent">Menu</h2><button id="close-sidebar-btn" class="md:hidden text-2xl text-main-font leading-none">&times;</button></div>
        <nav class="p-4 space-y-2">
            <a href="#" class="sidebar-link active" data-tab="intro"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>Gi·ªõi Thi·ªáu</a>
            <a href="#" class="sidebar-link" data-tab="add-student"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>Th√™m Sinh Vi√™n</a>
            <a href="#" class="sidebar-link" data-tab="student-list"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Danh S√°ch SV</a>
            <a href="#" class="sidebar-link" data-tab="contact"><svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>Li√™n H·ªá</a>
        </nav>
    </aside>
    <div id="sidebar-backdrop" class="sidebar-backdrop md:hidden"></div>
    <div class="flex-1 md:ml-64 transition-all duration-300 min-h-screen p-4 sm:p-6 flex flex-col items-center">
        <header class="w-full max-w-4xl mx-auto p-4 flex flex-col sm:flex-row items-center justify-center text-center">
            <button id="open-sidebar-btn" class="md:hidden fixed top-4 left-4 z-40 p-2 bg-card-bg rounded-md text-main-font"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button>
            <img src="https://uploads.onecompiler.io/43u4wb3ft/43unfu266/Black%20and%20White%20Circle%20Class%20Logo.png" alt="Logo" class="h-24 w-24 mb-4 sm:mb-0 sm:mr-4 rounded-full">
            <div>
                <h1 class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300 py-2">QU·∫¢N L√ù TH√îNG TIN & ƒêI·ªÇM SV</h1>
                <p class="text-sm text-gray-400 mt-1">B·∫¢N TH·ª¨ NGHI·ªÜM C·ª¶A FOXSTUDIO</p>
            </div>
        </header>
        <main id="tab-content" class="w-full max-w-4xl mx-auto p-4 space-y-8"></main>
        <footer class="w-full max-w-4xl mx-auto mt-12 text-center text-main-font"><p class="text-sm text-slate-500">Ph√°t tri·ªÉn b·ªüi FOXSTUDIO.</p><p class="text-sm text-slate-500">M·ªåI TH·∫ÆC M·∫ÆC LI√äN H·ªÜ : nguyenvanhai.10a3@gmail.</p></footer>
    </div>
    <div class="fixed-buttons"><button id="openThemeModalBtn" class="p-3 rounded-full bg-yellow-500/80 shadow-lg cursor-pointer hover:bg-yellow-500 transition-all"><img src="https://png.pngtree.com/element_our/20200702/ourmid/pngtree-settings-icon-image_2290382.jpg" alt="Settings Icon" class="h-8 w-8 rounded-full"></button><div id="chatbot-button" class="p-3 rounded-full bg-sky-500/80 shadow-lg cursor-pointer hover:bg-sky-500 transition-all"><img src="https://www.shutterstock.com/image-vector/chat-bot-icon-virtual-smart-600nw-2478937553.jpg" alt="Chatbot Icon" class="h-8 w-8 rounded-full"></div><button id="openPrintModalBtn" class="btn-secondary bg-sky-500/80 rounded-full p-3 shadow-lg print-button"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg></button></div>
    <div id="printModal" class="modal">
        <div class="modal-content"><button id="closePrintModalBtn" class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h3 class="text-xl font-semibold text-accent mb-4">Ch·ªçn Sinh Vi√™n ƒë·ªÉ In</h3><div id="printOptionsContainer" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div><div class="mt-6 flex justify-end gap-3"><button id="printAllBtn" class="btn-primary">In T·∫•t C·∫£</button><button id="printSelectedBtn" class="btn-primary" disabled>In ƒê√£ Ch·ªçn</button></div></div>
    </div>
    <div id="editStudentModal" class="modal">
        <div class="modal-content"><button id="closeEditStudentModalBtn" class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h3 class="text-xl font-semibold text-accent mb-4">Ch·ªânh S·ª≠a Th√¥ng Tin Sinh Vi√™n</h3><form id="editStudentForm" class="space-y-4"><input type="hidden" id="editStudentId" /><div><label class="block text-sm font-medium text-main-font mb-1">H·ªç v√† T√™n</label><input type="text" id="editStudentName" class="input-style" required /></div><div><label class="block text-sm font-medium text-main-font mb-1">M√£ S·ªë Sinh Vi√™n</label><input type="text" id="editStudentIdInp" class="input-style" disabled /></div><div><label class="block text-sm font-medium text-main-font mb-1">L·ªõp</label><input type="text" id="editStudentClass" class="input-style" /></div><div><label class="block text-sm font-medium text-main-font mb-1">Khoa/Ng√†nh</label><input type="text" id="editStudentFaculty" class="input-style" /></div><button type="submit" class="w-full btn-primary">L∆∞u Thay ƒê·ªïi</button></form></div>
    </div>
    <div id="themeModal" class="modal">
        <div class="modal-content"><button id="closeThemeModalBtn" class="modal-close-btn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button><h3 class="text-xl font-semibold text-accent mb-4">T√πy Ch·ªânh Giao Di·ªán</h3><div class="space-y-4"><div><h4 class="text-lg font-medium text-main-font mb-2">Ch·∫ø ƒë·ªô giao di·ªán</h4><div class="flex gap-4"><button id="lightModeBtn" class="btn-secondary w-full">S√°ng</button><button id="darkModeBtn" class="btn-secondary w-full">T·ªëi</button></div></div><div><h4 class="text-lg font-medium text-main-font mb-2">M√†u ch·ªß ƒë·∫°o</h4><input type="color" id="accentColorPicker" class="w-full h-12 rounded-lg cursor-pointer p-1 border border-input-border" /></div><div><h4 class="text-lg font-medium text-main-font mb-2">M√†u ch·ªØ</h4><input type="color" id="fontColorPicker" class="w-full h-12 rounded-lg cursor-pointer p-1 border border-input-border" /></div><div><h4 class="text-lg font-medium text-main-font mb-2">M√†u n·ªÅn th·∫ª</h4><input type="color" id="cardBgColorPicker" class="w-full h-12 rounded-lg cursor-pointer p-1 border border-input-border" /></div><div><h4 class="text-lg font-medium text-main-font mb-2">·∫¢nh n·ªÅn</h4><input type="file" id="bgImageFile" accept="image/*" class="input-style"><p class="text-sm text-slate-400 mt-2">Ch·ªçn m·ªôt ·∫£nh t·ª´ m√°y t√≠nh ƒë·ªÉ l√†m ·∫£nh n·ªÅn.</p><button id="removeBgBtn" class="w-full btn-outline-red mt-4">X√≥a ·∫£nh n·ªÅn</button></div></div></div>
    </div>
    <div id="chatbot-window" class="chatbot-container">
        <div class="chatbot-header" id="chatbot-header"><span>Chatbot h·ªó tr·ª£</span><button id="close-chatbot-btn" class="p-1 rounded-full hover:bg-white/20"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div>
        <div class="chatbot-messages" id="chatbot-messages"><div class="message bot-message">Xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n v·ªÅ ·ª©ng d·ª•ng n√†y?</div></div>
        <div class="p-4 border-t border-border-color"><div class="flex items-center gap-2"><input type="text" id="chatbot-input-field" class="input-style flex-grow" placeholder="Nh·∫≠p tin nh·∫Øn..." /><button id="send-btn" class="p-3 rounded-full bg-sky-500 text-white hover:bg-sky-600"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg></button></div></div>
    </div>
    <div id="printContent" style="display: none;"></div>

    <script>
        // ======= Config & State =======
        let students = [];

        // ======= Theme & Background (Kh√¥ng ƒë·ªïi) =======
        const THEME_KEY = 'html-gpa-multi-student:theme';
        const BG_KEY = 'html-gpa-multi-student:background';
        const ACCENT_KEY = 'html-gpa-multi-student:accent';
        const FONT_COLOR_KEY = 'html-gpa-multi-student:font-color';
        const CARD_BG_KEY = 'html-gpa-multi-student:card-bg';

        function applyTheme(theme) { document.body.classList.toggle('light-mode', theme === 'light'); localStorage.setItem(THEME_KEY, theme); }
        function loadTheme() { applyTheme(localStorage.getItem(THEME_KEY) || 'dark'); }
        function applyAccentColor(color) { document.documentElement.style.setProperty('--accent-color', color); localStorage.setItem(ACCENT_KEY, color); }
        function loadAccentColor() { const c = localStorage.getItem(ACCENT_KEY) || '#0ea5e9'; applyAccentColor(c); const p = document.getElementById('accentColorPicker'); if(p) p.value = c; }
        function applyFontColor(color) { document.documentElement.style.setProperty('--main-font-color', color); localStorage.setItem(FONT_COLOR_KEY, color); }
        function loadFontColor() { const c = localStorage.getItem(FONT_COLOR_KEY) || 'var(--text-color)'; applyFontColor(c); const p = document.getElementById('fontColorPicker'); if(p) p.value = c; }
        function applyCardBgColor(color) { document.documentElement.style.setProperty('--card-bg', color); localStorage.setItem(CARD_BG_KEY, color); }
        function loadCardBgColor() { const c = localStorage.getItem(CARD_BG_KEY) || '#1e293b'; applyCardBgColor(c); const p = document.getElementById('cardBgColorPicker'); if(p) p.value = c; }
        function applyBackground(url) { if(url){ document.body.style.backgroundImage = `url('${url}')`; document.body.classList.add('custom-bg'); localStorage.setItem(BG_KEY, url); } else { document.body.style.backgroundImage = ''; document.body.classList.remove('custom-bg'); localStorage.removeItem(BG_KEY); } }
        function loadBackground() { const bg = localStorage.getItem(BG_KEY); if (bg) applyBackground(bg); }
        
        // ======= Grade Conversion (Kh√¥ng ƒë·ªïi) =======
        function avgToLetter(d) { if (d >= 8.5) return 'A'; if (d >= 7.8) return 'B+'; if (d >= 7.0) return 'B'; if (d >= 6.3) return 'C+'; if (d >= 5.5) return 'C'; if (d >= 4.8) return 'D+'; if (d >= 4.0) return 'D'; return 'F'; }
        function avgToPoint4(d) { if (d >= 8.5) return 4.0; if (d >= 7.8) return 3.5; if (d >= 7.0) return 3.0; if (d >= 6.3) return 2.5; if (d >= 5.5) return 2.0; if (d >= 4.8) return 1.5; if (d >= 4.0) return 1.0; return 0.0; }
        function gradeToPoint(g) { const s=String(g).toUpperCase().trim(); const n=parseFloat(s); if(!isNaN(n)&&n>=0&&n<=4)return n; switch(s){case 'A':return 4.0;case 'B+':return 3.5;case 'B':return 3.0;case 'C+':return 2.5;case 'C':return 2.0;case 'D+':return 1.5;case 'D':return 1.0;case 'F':return 0.0;default:return NaN;}}

        // ======= GPA Calculation (Kh√¥ng ƒë·ªïi) =======
        function computeGPA(courses = []) {
            if (!courses || !courses.length) return 0;
            let totalPoints = 0, totalCredits = 0;
            courses.forEach(c => {
                const cred = parseFloat(c.credits);
                const point = (typeof c.point4 === 'number') ? c.point4 : gradeToPoint(c.grade);
                if (!isNaN(cred) && cred > 0 && !isNaN(point)) {
                    totalPoints += point * cred;
                    totalCredits += cred;
                }
            });
            return totalCredits === 0 ? 0 : (totalPoints / totalCredits);
        }

        // ======= Firebase Functions (Phi√™n b·∫£n ƒë·∫ßy ƒë·ªß CRUD) =======
        async function loadStudentsFromFirebase() {
            try {
                const { db, collection, getDocs } = window.firebase;
                const studentSnapshot = await getDocs(collection(db, 'students'));
                const studentList = [];
                studentSnapshot.forEach(doc => {
                    studentList.push({ firebaseId: doc.id, ...doc.data() });
                });
                students = studentList;
            } catch (error) { console.error("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:", error); alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu."); }
        }

        async function addNewStudent(e) {
            e.preventDefault();
            const { db, collection, addDoc } = window.firebase;
            const studentError = document.getElementById('studentError');
            const newStudentId = document.getElementById('newStudentId').value.trim();
            if (students.find(s => s.studentId === newStudentId)) { studentError.textContent = 'M√£ s·ªë sinh vi√™n ƒë√£ t·ªìn t·∫°i.'; return; }
            
            const newStudentData = {
                name: document.getElementById('newStudentName').value,
                studentId: newStudentId,
                class: document.getElementById('newStudentClass').value,
                faculty: document.getElementById('newStudentFaculty').value,
                courses: []
            };

            try {
                const docRef = await addDoc(collection(db, 'students'), newStudentData);
                students.push({ firebaseId: docRef.id, ...newStudentData });
                renderStudents();
                updateDashboard();
                document.getElementById('studentForm').reset();
                studentError.textContent = '';
                alert('ƒê√£ th√™m sinh vi√™n m·ªõi th√†nh c√¥ng l√™n Firebase!');
            } catch (error) { console.error("L·ªói khi th√™m sinh vi√™n:", error); alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi l∆∞u sinh vi√™n."); }
        }

        async function deleteStudent(firebaseId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                try {
                    const { db, doc, deleteDoc } = window.firebase;
                    await deleteDoc(doc(db, 'students', firebaseId));
                    students = students.filter(s => s.firebaseId !== firebaseId);
                    renderStudents();
                    updateDashboard();
                    alert('ƒê√£ x√≥a sinh vi√™n th√†nh c√¥ng.');
                } catch (error) { console.error("L·ªói khi x√≥a sinh vi√™n:", error); alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi x√≥a sinh vi√™n."); }
            }
        }

        async function updateStudent(e) {
            e.preventDefault();
            const { db, doc, updateDoc } = window.firebase;
            const firebaseId = document.getElementById('editStudentId').value;
            const studentInDb = students.find(s => s.firebaseId === firebaseId);
            if (!studentInDb) return;

            const updatedData = {
                name: document.getElementById('editStudentName').value,
                class: document.getElementById('editStudentClass').value,
                faculty: document.getElementById('editStudentFaculty').value,
            };

            try {
                const studentRef = doc(db, 'students', firebaseId);
                await updateDoc(studentRef, updatedData);

                // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu ·ªü client
                studentInDb.name = updatedData.name;
                studentInDb.class = updatedData.class;
                studentInDb.faculty = updatedData.faculty;

                renderStudents();
                updateDashboard();
                document.getElementById('editStudentModal').classList.remove('show');
                alert('C·∫≠p nh·∫≠t th√¥ng tin sinh vi√™n th√†nh c√¥ng.');
            } catch (error) { console.error("L·ªói khi c·∫≠p nh·∫≠t sinh vi√™n:", error); alert('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin.'); }
        }

        async function updateStudentCourses(firebaseId, newCourses) {
            try {
                const { db, doc, updateDoc } = window.firebase;
                const studentRef = doc(db, 'students', firebaseId);
                await updateDoc(studentRef, { courses: newCourses });
                
                const student = students.find(s => s.firebaseId === firebaseId);
                if (student) student.courses = newCourses;
                
                renderStudents();
                updateDashboard();
            } catch (error) { console.error("L·ªói khi c·∫≠p nh·∫≠t m√¥n h·ªçc:", error); alert('L·ªói khi l∆∞u thay ƒë·ªïi m√¥n h·ªçc.'); }
        }

        // ======= Tab Content & Main Logic =======
        const tabContentHtml = {
            'intro': `
                <section id="intro" class="content-section active bg-card-bg shadow-2xl rounded-xl p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-accent">Gi·ªõi Thi·ªáu</h2>
                    <div class="space-y-4 text-main-font"><p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ·ª©ng d·ª•ng t√≠nh ƒëi·ªÉm v√† qu·∫£n l√Ω th√¥ng tin sinh vi√™n c·ªßa FOXSTUDIO. ·ª®ng d·ª•ng n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ gi√∫p b·∫°n d·ªÖ d√†ng theo d√µi k·∫øt qu·∫£ h·ªçc t·∫≠p, t√≠nh to√°n ƒëi·ªÉm trung b√¨nh (GPA) v√† l∆∞u tr·ªØ th√¥ng tin c√° nh√¢n.</p><p>V·ªõi giao di·ªán tr·ª±c quan, b·∫°n c√≥ th·ªÉ th√™m nhi·ªÅu sinh vi√™n, c·∫≠p nh·∫≠t ƒëi·ªÉm c√°c m√¥n h·ªçc v√† xem ƒëi·ªÉm GPA ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông. T√≠nh nƒÉng in ·∫•n cho ph√©p b·∫°n xu·∫•t b·∫£n in th√¥ng tin v√† k·∫øt qu·∫£ h·ªçc t·∫≠p ra file PDF m·ªôt c√°ch nhanh ch√≥ng.</p></div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-4 text-main-font">Th·ªëng k√™ nhanh</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                            <div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-sm text-slate-400">T·ªïng s·ªë sinh vi√™n</p><p id="totalStudents" class="text-3xl font-bold text-accent">0</p></div>
                            <div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-sm text-slate-400">T·ªïng s·ªë t√≠n ch·ªâ</p><p id="totalCredits" class="text-3xl font-bold text-accent">0</p></div>
                            <div class="bg-slate-700/50 p-4 rounded-lg"><p class="text-sm text-slate-400">GPA trung b√¨nh</p><p id="avgGpa" class="text-3xl font-bold text-accent">0.00</p></div>
                        </div>
                    </div>
                    <div class="qr-code-section flex flex-col sm:flex-row items-center justify-center gap-6 mt-10">
                        <img src="https://uploads.onecompiler.io/43u4wb3ft/43unfu266/APPTTSV.png" alt="QR Code" class="h-[150px] w-[150px] rounded-xl">
                        <h2 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300 py-2">QU√âT QR CODE NGAY ƒê·ªÇ <br class="hidden sm:block"> T·∫¢I APP MOBILE.</h2>
                    </div>
                </section>`,
            'add-student': `
                <section id="add-student" class="content-section bg-card-bg shadow-2xl rounded-xl p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-accent">Th√™m Sinh Vi√™n M·ªõi</h2>
                    <form id="studentForm" class="space-y-3">
                        <div><label class="block text-sm font-medium text-main-font mb-1">H·ªç v√† T√™n</label><input type="text" id="newStudentName" class="input-style" placeholder="Nguy·ªÖn VƒÉn A" required /></div>
                        <div><label class="block text-sm font-medium text-main-font mb-1">M√£ S·ªë Sinh Vi√™n</label><input type="text" id="newStudentId" class="input-style" placeholder="20201234" required /></div>
                        <div><label class="block text-sm font-medium text-main-font mb-1">L·ªõp</label><input type="text" id="newStudentClass" class="input-style" placeholder="CNTT-K65" /></div>
                        <div><label class="block text-sm font-medium text-main-font mb-1">Khoa/Ng√†nh</label><input type="text" id="newStudentFaculty" class="input-style" placeholder="C√¥ng ngh·ªá Th√¥ng tin" /></div>
                        <p id="studentError" class="text-red-400 text-sm"></p>
                        <div class="pt-2"><button type="submit" class="w-full btn-primary" id="btnAddNewStudent"><img src="https://cdn-icons-png.flaticon.com/512/992/992651.png" class="w-5 h-5"><span class="ml-2">Th√™m Sinh Vi√™n</span></button></div>
                    </form>
                </section>`,
            'student-list': `
                <section id="student-list" class="content-section">
                    <div class="bg-card-bg shadow-2xl rounded-xl p-6 mb-6">
                        <h2 class="text-2xl font-semibold mb-6 text-accent">Qu·∫£n L√Ω Sinh Vi√™n</h2>
                        <div class="mb-6"><input type="text" id="searchInput" class="input-style" placeholder="üîç T√¨m ki·∫øm theo t√™n, MSSV, l·ªõp ho·∫∑c khoa..."></div>
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div class="flex items-center gap-2">
                                <label for="sortOrder" class="text-sm font-medium text-main-font">S·∫Øp x·∫øp theo:</label>
                                <select id="sortOrder" class="input-style-sm"><option value="name-asc">T√™n (A-Z)</option><option value="name-desc">T√™n (Z-A)</option><option value="gpa-desc">GPA (Cao - Th·∫•p)</option><option value="gpa-asc">GPA (Th·∫•p - Cao)</option></select>
                            </div>
                            <div class="flex gap-2">
                                <button id="exportDataBtn" class="btn-outline-blue text-sm">Xu·∫•t D·ªØ li·ªáu</button>
                                <label for="importFile" class="btn-outline-blue text-sm cursor-pointer">Nh·∫≠p D·ªØ li·ªáu<input type="file" id="importFile" accept=".json" class="hidden"></label>
                            </div>
                        </div>
                    </div>
                    <div id="studentsContainer" class="space-y-8"></div>
                </section>`,
            'contact': `
                <section id="contact" class="content-section bg-card-bg shadow-2xl rounded-xl p-6">
                    <h2 class="text-2xl font-semibold mb-6 text-accent">Li√™n H·ªá</h2>
                    <p class="text-sm text-main-font mb-4">K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i qua c√°c k√™nh sau ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ v√† c·∫≠p nh·∫≠t th√¥ng tin m·ªõi nh·∫•t!</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <a href="https://www.facebook.com/nguyen.hai.225063" target="_blank" rel="noopener" class="w-full btn-outline-blue flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-1.667c0-.955.192-1.333 1.58-1.333h2.42v-4h-3.998c-2.761 0-4.002 1.147-4.002 3.205v1.795z"/></svg><span>Li√™n h·ªá Facebook</span></a>
                        <a href="mailto:nguyenvanhai.10a3@gmail.com" class="w-full btn-outline-red flex items-center justify-center"><img src="https://png.pngtree.com/element_our/png/20181213/inbox-vector-icon-png_267453.jpg" alt="Email Icon" class="w-6 h-6 mr-2 rounded-full" ><span>G·ª≠i Email</span></a>
                    </div>
                </section>
                <section class="bg-card-bg shadow-2xl rounded-xl p-6">
                    <div class="flex items-center mb-4"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-6 h-6 mr-2 text-red-500" viewBox="0 0 24 24"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.25,4,12,4,12,4S5.75,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.75,2,12,2,12s0,4.25,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.75,20,12,20,12,20s6.25,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.25,22,12,22,12S22,7.75,21.582,6.186z M10,15.5v-7l6,3.5L10,15.5z"/></svg><h2 class="text-2xl font-semibold text-red-500">K√™nh YouTube ƒê·ªÅ Xu·∫•t</h2></div>
                    <div><h3 class="text-xl font-semibold text-accent" id="ytName">K√™nh YouTube c·ªßa FOX</h3><p class="text-sm text-main-font mt-1 mb-3" id="ytDesc">N∆°i chia s·∫ª nh·ªØng video h·ªØu √≠ch v√† th√∫ v·ªã. H√£y gh√© thƒÉm v√† ·ªßng h·ªô nh√©!</p><a id="ytUrl" href="https://www.youtube.com/channel/UCSRG41tE6J27W5SCsAVahGw" target="_blank" rel="noopener" class="btn-outline-red">Xem K√™nh v√† ƒêƒÉng k√Ω</a></div>
                </section>
                <section class="bg-card-bg shadow-2xl rounded-xl p-6">
                    <div class="flex items-center mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A11.978 11.978 0 0 1 12 13.5c-2.998 0-5.74-1.1-7.843-2.918M3.284 9.747c0-.778.099-1.533.284-2.253" /></svg><h2 class="text-2xl font-semibold text-blue-500">Website c·ªßa tr∆∞·ªùng </h2></div>
                    <div><h3 class="text-xl font-semibold text-accent" id="webName">TRANG TT C·ª¶A TR∆Ø·ªúNG ƒêH PH·∫†M VƒÇN ƒê·ªíNG</h3><p class="text-sm text-main-font mt-1 mb-3" id="webDesc">Kh√°m ph√° nh·ªØng ki·∫øn th·ª©c b·ªï √≠ch v√† c√¥ng c·ª• h·ªçc t·∫≠p tuy·ªát v·ªùi t·∫°i ƒë√¢y!</p><a id="webUrl" href="https://www.pdu.edu.vn/" target="_blank" rel="noopener" class="btn-outline-blue">Truy c·∫≠p Website</a></div>
                </section>`,
        };

        function switchTab(tabName) {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            const tabContentContainer = document.getElementById('tab-content');
            tabContentContainer.innerHTML = tabContentHtml[tabName];

            if (tabName === 'intro') {
                updateDashboard();
            } else if (tabName === 'student-list') {
                const sortOrderSelect = document.getElementById('sortOrder');
                const exportDataBtn = document.getElementById('exportDataBtn');
                const importFileInp = document.getElementById('importFile');
                const searchInput = document.getElementById('searchInput');

                sortOrderSelect.addEventListener('change', (e) => sortStudents(e.target.value));
                exportDataBtn.addEventListener('click', exportData);
                importFileInp.addEventListener('change', importData);

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    const filteredStudents = students.filter(student => 
                        student.name.toLowerCase().includes(searchTerm) || 
                        student.studentId.toLowerCase().includes(searchTerm) ||
                        (student.class || '').toLowerCase().includes(searchTerm) ||
                        (student.faculty || '').toLowerCase().includes(searchTerm)
                    );
                    renderStudents(filteredStudents);
                });
                renderStudents();
            } else if (tabName === 'add-student') {
                const studentForm = document.getElementById('studentForm');
                studentForm.addEventListener('submit', addNewStudent);
            }
        }
        
        function attachEventListeners() {
            document.getElementById('editStudentForm')?.addEventListener('submit', updateStudent);
            
            document.querySelectorAll('[data-edit-student]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const student = students.find(s => s.firebaseId === e.currentTarget.dataset.editStudent);
                    if (student) {
                        document.getElementById('editStudentId').value = student.firebaseId;
                        document.getElementById('editStudentName').value = student.name;
                        document.getElementById('editStudentIdInp').value = student.studentId;
                        document.getElementById('editStudentClass').value = student.class;
                        document.getElementById('editStudentFaculty').value = student.faculty;
                        document.getElementById('editStudentModal').classList.add('show');
                    }
                });
            });
            
            document.querySelectorAll('[data-del-student]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteStudent(e.currentTarget.dataset.delStudent);
                });
            });
            
            document.querySelectorAll('[data-del-course]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const student = students.find(s => s.firebaseId === e.currentTarget.dataset.studentId);
                    if (student) {
                        const newCourses = student.courses.filter(c => c.id !== e.currentTarget.dataset.delCourse);
                        updateStudentCourses(student.firebaseId, newCourses);
                    }
                });
            });
            
            document.querySelectorAll('.course-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const student = students.find(s => s.firebaseId === e.target.dataset.studentId);
                    if (!student) return;

                    const courseError = e.target.querySelector('.course-error');
                    courseError.textContent = '';
                    
                    const courseName = e.target.querySelector('.courseNameInp').value;
                    const credits = parseFloat(e.target.querySelector('.creditsInp').value);
                    let newCourse = { id: 'c-' + Date.now(), name: courseName, credits: credits };

                    const isDetailed = e.target.querySelector('.toggleDetailed').checked;
                    if (isDetailed) {
                        const hs1 = parseFloat(e.target.querySelector('.hs1Inp').value);
                        const hs2 = parseFloat(e.target.querySelector('.hs2Inp').value);
                        const thi = parseFloat(e.target.querySelector('.thiInp').value);
                        if (isNaN(hs1) || isNaN(hs2) || isNaN(thi)) { courseError.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√°c ƒëi·ªÉm chi ti·∫øt.'; return; }
                        const avg = (hs1 + hs2 * 2 + thi * 3) / 6;
                        newCourse = { ...newCourse, hs1, hs2, thi, avg, grade: avgToLetter(avg), point4: avgToPoint4(avg) };
                    } else {
                        const gradeValue = e.target.querySelector('.gradeInput').value.trim();
                        const avgValue = e.target.querySelector('.avgInput').value.trim();
                        if (!gradeValue && !avgValue) { courseError.textContent = 'Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ªïng k·∫øt ho·∫∑c ƒëi·ªÉm h·ªçc ph·∫ßn.'; return; }
                        if (gradeValue) {
                            const point4 = gradeToPoint(gradeValue);
                            if (isNaN(point4)) { courseError.textContent = 'ƒêi·ªÉm ch·ªØ kh√¥ng h·ª£p l·ªá.'; return; }
                            newCourse = { ...newCourse, grade: gradeValue, point4: point4 };
                        } else if (avgValue) {
                            const avg = parseFloat(avgValue);
                            if (isNaN(avg) || avg < 0 || avg > 10) { courseError.textContent = 'ƒêi·ªÉm h·ªçc ph·∫ßn kh√¥ng h·ª£p l·ªá.'; return; }
                            newCourse = { ...newCourse, avg, grade: avgToLetter(avg), point4: avgToPoint4(avg) };
                        }
                    }
                    const newCourses = [...student.courses, newCourse];
                    updateStudentCourses(student.firebaseId, newCourses);
                    form.reset();
                });
            });

            document.querySelectorAll('.toggleDetailed').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const form = e.currentTarget.closest('.course-form');
                    const simpleArea = form.querySelector('.simpleGradeArea');
                    const detailedArea = form.querySelector('.detailedArea');
                    simpleArea.classList.toggle('hidden', e.currentTarget.checked);
                    detailedArea.classList.toggle('hidden', !e.currentTarget.checked);
                });
            });

            document.querySelectorAll('.detailedArea input[type="number"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const form = e.currentTarget.closest('.course-form');
                    const hs1 = parseFloat(form.querySelector('.hs1Inp').value) || 0;
                    const hs2 = parseFloat(form.querySelector('.hs2Inp').value) || 0;
                    const thi = parseFloat(form.querySelector('.thiInp').value) || 0;
                    const avg = (hs1 + hs2 * 2 + thi * 3) / 6;
                    const grade = avgToLetter(avg);
                    const point4 = avgToPoint4(avg);
                    const detailedResult = form.querySelector('.detailedResult');
                    detailedResult.innerHTML = `<p>ƒêi·ªÉm TB (h·ªá 10): <strong>${avg.toFixed(2)}</strong></p><p>ƒêi·ªÉm ch·ªØ: <strong>${grade}</strong></p><p>ƒêi·ªÉm h·ªá 4: <strong>${point4.toFixed(1)}</strong></p>`;
                    detailedResult.classList.remove('hidden');
                });
            });
        }
        
        function updateDashboard() {
            const totalStudentsEl = document.getElementById('totalStudents');
            if (!totalStudentsEl) return;
            const totalCreditsEl = document.getElementById('totalCredits');
            const avgGpaEl = document.getElementById('avgGpa');
            const totalStudents = students.length;
            let totalCredits = 0;
            let gpaSum = 0;
            students.forEach(student => {
                student.courses.forEach(course => { totalCredits += parseFloat(course.credits) || 0; });
                gpaSum += computeGPA(student.courses);
            });
            const avgGpa = totalStudents > 0 ? (gpaSum / totalStudents) : 0;
            totalStudentsEl.textContent = totalStudents;
            totalCreditsEl.textContent = totalCredits;
            avgGpaEl.textContent = avgGpa.toFixed(2);
        }

        function sortStudents(sortType) {
            switch(sortType) {
                case 'name-asc': students.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name-desc': students.sort((a, b) => b.name.localeCompare(a.name)); break;
                case 'gpa-desc': students.sort((a, b) => computeGPA(b.courses) - computeGPA(a.courses)); break;
                case 'gpa-asc': students.sort((a, b) => computeGPA(a.courses) - computeGPA(b.courses)); break;
            }
            renderStudents();
            updateDashboard();
        }
        
        function exportData() { /* ... */ }
        function importData(e) { /* ... */ }
        
        function renderStudents(studentsToRender = students) {
            const studentsContainer = document.getElementById('studentsContainer');
            if (!studentsContainer) return;
            studentsContainer.innerHTML = '';
            if (studentsToRender.length === 0) { studentsContainer.innerHTML = `<p class="text-main-font text-center py-10 w-full col-span-full">Kh√¥ng t√¨m th·∫•y sinh vi√™n n√†o.</p>`; return; }
            
            studentsToRender.forEach(student => {
                const gpa = computeGPA(student.courses);
                const cardHtml = `
                    <div class="student-card bg-card-bg shadow-2xl rounded-xl p-6 relative">
                        <div class="flex items-center absolute top-2 right-2">
                             <button class="btn-icon-edit" data-edit-student="${student.firebaseId}" title="Ch·ªânh s·ª≠a"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button>
                             <button class="btn-icon-danger" data-del-student="${student.firebaseId}" title="X√≥a SV"><svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        <div class="mb-6 pb-4 border-b border-border-color">
                            <h3 class="text-xl font-semibold text-accent">${student.name}</h3>
                            <p class="text-sm text-main-font">MSSV: ${student.studentId}</p>
                            <p class="text-sm text-main-font">L·ªõp: ${student.class || 'N/A'}</p>
                            <p class="text-sm text-main-font">Khoa: ${student.faculty || 'N/A'}</p>
                            <div class="mt-4 bg-slate-700 px-4 py-2 rounded-lg shadow">
                                <span class="text-main-font font-medium">GPA: </span>
                                <span class="text-2xl font-bold text-emerald-400">${gpa.toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="space-y-4 mb-6">
                            <h4 class="text-lg font-semibold text-accent">Th√™m M√¥n H·ªçc</h4>
                            <form class="course-form" data-student-id="${student.firebaseId}">
                                <div><label class="block text-sm font-medium text-main-font mb-1">T√™n M√¥n H·ªçc</label><input type="text" class="courseNameInp input-style" placeholder="VD: L·∫≠p tr√¨nh Web" required /></div>
                                <div><label class="block text-sm font-medium text-main-font mb-1">S·ªë T√≠n Ch·ªâ</label><input type="number" class="creditsInp input-style" placeholder="VD: 3" min="0.5" step="0.5" required /></div>
                                <div class="flex items-center space-x-2 pt-4"><input type="checkbox" class="toggleDetailed h-4 w-4 rounded border-slate-600 text-accent focus:ring-accent"/><label class="text-sm font-medium text-main-font">Nh·∫≠p ƒëi·ªÉm chi ti·∫øt</label></div>
                                <div class="simpleGradeArea space-y-3 mt-3">
                                    <div><label class="block text-sm font-medium text-main-font mb-1">ƒêi·ªÉm Ch·ªØ (A-F) ho·∫∑c H·ªá 4 (0-4)</label><input type="text" class="gradeInput input-style" placeholder="VD: A, B+, 3.5" /></div>
                                    <div><label class="block text-sm font-medium text-main-font mb-1">HO·∫∂C ƒêi·ªÉm H·ªçc Ph·∫ßn (H·ªá 10)</label><input type="number" class="avgInput input-style" placeholder="VD: 8.5" step="0.1" min="0" max="10" /></div>
                                </div>
                                <div class="detailedArea space-y-4 p-4 border border-slate-700 rounded-lg mt-2 hidden">
                                    <h5 class="text-base font-semibold text-accent">Chi Ti·∫øt ƒêi·ªÉm</h5>
                                    <div class="grid grid-cols-3 gap-3">
                                        <div><label class="block text-xs text-main-font mb-1">HS1</label><input type="number" step="0.1" min="0" max="10" class="hs1Inp input-style-sm"/></div>
                                        <div><label class="block text-xs text-main-font mb-1">HS2</label><input type="number" step="0.1" min="0" max="10" class="hs2Inp input-style-sm"/></div>
                                        <div><label class="block text-xs text-main-font mb-1">Thi</label><input type="number" step="0.1" min="0" max="10" class="thiInp input-style-sm"/></div>
                                    </div>
                                    <div class="detailedResult mt-3 p-3 bg-slate-700/50 rounded-md text-sm"></div>
                                </div>
                                <p class="course-error text-red-400 text-sm mt-2"></p>
                                <button type="submit" class="w-full btn-primary mt-4">Th√™m M√¥n</button>
                            </form>
                        </div>
                        <div class="course-table-wrap">${renderCourseTable(student.courses, false, student.firebaseId)}</div>
                    </div>`;
                studentsContainer.innerHTML += cardHtml;
            });
            attachEventListeners();
        }

        function renderCourseTable(courses, forPrint = false, studentId = '') {
            if (!courses || !courses.length) { return forPrint ? `<p class="text-center py-4">Ch∆∞a c√≥ m√¥n h·ªçc.</p>` : `<p class="text-main-font text-center py-4 text-sm">Ch∆∞a c√≥ m√¥n h·ªçc.</p>`; }
            const rows = courses.map(c => `
                <tr class="border-b ${forPrint ? 'border-gray-300' : 'border-slate-700/50'}">
                    <td class="td-style !p-2">${c.name}</td>
                    <td class="td-style !p-2 text-center">${c.credits}</td>
                    <td class="td-style !p-2 text-center">${(typeof c.avg === 'number') ? c.avg.toFixed(2) : '-'}</td>
                    <td class="td-style !p-2 text-center">${c.grade || '-'}</td>
                    <td class="td-style !p-2 text-center">${(typeof c.point4 === 'number') ? c.point4.toFixed(1) : '-'}</td>
                    <td class="${forPrint ? 'hidden' : 'td-style !p-2 text-center'}">
                        <button class="btn-icon-danger" data-del-course="${c.id}" data-student-id="${studentId}" title="X√≥a"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    </td>
                </tr>`).join('');
            return `
                <div class="course-table-wrap">
                    <table class="w-full text-left text-sm">
                        <thead class="border-b border-border-color/50">
                            <tr><th class="th-style !p-2">T√™n M√¥n</th><th class="th-style !p-2 text-center">TC</th><th class="th-style !p-2 text-center">ƒêi·ªÉm HP</th><th class="th-style !p-2 text-center">Ch·ªØ</th><th class="th-style !p-2 text-center">H·ªá 4</th><th class="${forPrint ? 'hidden' : 'th-style !p-2 text-center'}">X√≥a</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>`;
        }
        
        function renderPrintOptions() {
            // ... (H√†m n√†y ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng)
        }
        function createPrintContent(selectedStudents) {
            // ... (H√†m n√†y ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng)
        }
        
        function updateDashboard() {
            // ... (H√†m n√†y ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng)
        }
        function sortStudents(sortType) {
            // ... (H√†m n√†y ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng)
        }
        function exportData() { /* ... */ }
        function importData(e) { /* ... */ }
        function appendMessage(text, type) { /* ... */ }
        async function handleChatbotResponse(message) { /* ... */ }
        async function getGeminiResponse(query) { /* ... */ }

        // ======= App Initialization =======
        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme();
            loadAccentColor();
            loadFontColor();
            loadCardBgColor();
            loadBackground();
            
            const openSidebarBtn = document.getElementById('open-sidebar-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            openSidebarBtn.addEventListener('click', () => { sidebar.classList.remove('-translate-x-full'); sidebarBackdrop.classList.add('active'); });
            closeSidebarBtn.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); sidebarBackdrop.classList.remove('active'); });
            sidebarBackdrop.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); sidebarBackdrop.classList.remove('active'); });
            
            const editStudentModal = document.getElementById('editStudentModal');
            document.getElementById('closeEditStudentModalBtn').addEventListener('click', () => editStudentModal.classList.remove('show'));
            document.getElementById('editStudentForm')?.addEventListener('submit', updateStudent);
            
            const printModal = document.getElementById('printModal');
            document.getElementById('openPrintModalBtn').addEventListener('click', () => { renderPrintOptions(); printModal.classList.add('show'); });
            document.getElementById('closePrintModalBtn').addEventListener('click', () => printModal.classList.remove('show'));
            document.getElementById('printAllBtn').addEventListener('click', () => { createPrintContent(students); window.print(); printModal.classList.remove('show'); });
            document.getElementById('printSelectedBtn').addEventListener('click', () => { const selectedIds = Array.from(document.querySelectorAll('.print-checkbox:checked')).map(cb => cb.getAttribute('data-student-id')); const selectedStudents = students.filter(s => selectedIds.includes(s.firebaseId)); createPrintContent(selectedStudents); window.print(); printModal.classList.remove('show'); });

            document.getElementById('openThemeModalBtn').addEventListener('click', () => document.getElementById('themeModal').classList.add('show'));
            document.getElementById('closeThemeModalBtn').addEventListener('click', () => document.getElementById('themeModal').classList.remove('show'));
            document.getElementById('lightModeBtn').addEventListener('click', () => applyTheme('light'));
            document.getElementById('darkModeBtn').addEventListener('click', () => applyTheme('dark'));
            document.getElementById('accentColorPicker').addEventListener('input', (e) => applyAccentColor(e.target.value));
            document.getElementById('fontColorPicker').addEventListener('input', (e) => applyFontColor(e.target.value));
            document.getElementById('cardBgColorPicker').addEventListener('input', (e) => applyCardBgColor(e.target.value));
            document.getElementById('bgImageFile').addEventListener('change', (e) => { /* ... */ });
            document.getElementById('removeBgBtn').addEventListener('click', () => applyBackground(null));
            
            document.getElementById('chatbot-button').addEventListener('click', () => document.getElementById('chatbot-window').classList.toggle('active'));
            document.getElementById('close-chatbot-btn').addEventListener('click', () => document.getElementById('chatbot-window').classList.remove('active'));
            document.getElementById('send-btn').addEventListener('click', () => { /* ... */ });
            document.getElementById('chatbot-input-field').addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('send-btn').click(); });
            
            document.getElementById('studentForm')?.addEventListener('submit', addNewStudent);
            
            await loadStudentsFromFirebase();
            switchTab('intro');
        });
    </script>
</body>
</html>
